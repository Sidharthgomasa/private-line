<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Line</title>
    <meta name="theme-color" content="#121212">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2913/2913133.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body { margin: 0; background: #121212; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        /* VIDEO CONTAINERS */
        #remoteVideo {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; display: none; background: #000;
        }
        #localVideo {
            position: absolute; bottom: 20px; right: 20px; width: 100px; height: 140px;
            background: #333; border: 2px solid #ff4d4d; border-radius: 10px;
            object-fit: cover; z-index: 2; transform: scaleX(-1); display: none;
        }

        /* UI LAYOUT */
        #ui-layer { position: relative; z-index: 10; text-align: center; width: 100%; }
        
        h1 { color: #ff4d4d; font-weight: 300; letter-spacing: 2px; }

        /* INPUTS */
        #pinInput {
            padding: 15px; font-size: 20px; border-radius: 12px;
            border: 2px solid #333; background: #222; color: white;
            text-align: center; width: 200px; margin-bottom: 25px; outline: none;
        }

        /* BUTTONS */
        .btn {
            padding: 15px 30px; font-size: 18px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold; margin: 10px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s; width: 80%; max-width: 300px;
        }
        .btn:active { transform: scale(0.95); }
        
        #callBtn { background: linear-gradient(145deg, #ff4d4d, #cc0000); }
        #videoStartBtn { background: linear-gradient(145deg, #444, #222); border: 1px solid #555; }
        
        /* HIDDEN BUTTONS (Show during call) */
        #inCallControls { display: none; }
        #endBtn { background: #cc0000; width: 60px; height: 60px; font-size: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }

        /* STATUS CIRCLE */
        .circle { width: 120px; height: 120px; background: #2a2a2a; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 20px auto; font-size: 40px; border: 2px solid #ff4d4d; }
        .pulse { animation: pulse 1.5s infinite; background: #ff4d4d; border: none; }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(255, 77, 77, 0); } 100% { transform: scale(0.95); } }

    </style>
</head>
<body>

    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>

    <div id="ui-layer">
        <div id="setup-ui">
            <h1>ðŸ”’ PRIVATE LINE</h1>
            <input type="tel" id="pinInput" placeholder="Enter PIN" maxlength="10">
            <br>
            <button id="callBtn" class="btn" onclick="startCall(false)">ðŸ“ž Voice Call (Try Earpiece)</button>
            <br>
            <button id="videoStartBtn" class="btn" onclick="startCall(true)">ðŸ“¹ Video Call</button>
        </div>

        <div id="inCallControls">
            <div id="visual" class="circle">ðŸš€</div>
            <div id="status" style="margin-bottom: 20px; color: #aaa;">Connecting...</div>
            <button id="endBtn" class="btn" onclick="location.reload()">ðŸ“ž</button>
        </div>
    </div>

    <audio id="remoteAudio" autoplay playsinline></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // --- PWA INSTALLATION ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js');
        }

        // --- APP LOGIC ---
        const socket = io();
        const uiSetup = document.getElementById('setup-ui');
        const uiInCall = document.getElementById('inCallControls');
        const statusDiv = document.getElementById('status');
        const visual = document.getElementById('visual');
        const remoteAudio = document.getElementById('remoteAudio');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');
        
        let peerConnection;
        let localStream;
        let isVideoCall = false;

        const METERED_API_KEY = "d79e5424a466fa259d9deecb140f92c064dd";
        let iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];

        window.onload = async () => {
            try {
                const response = await fetch(`https://connect-v.metered.live/api/v1/turn/credentials?apiKey=${METERED_API_KEY}`);
                iceServers = await response.json();
                console.log("Premium Servers Loaded");
            } catch (e) { console.error("Backup servers used"); }
        };

        // Unified Start Function
        async function startCall(videoMode) {
            const pin = document.getElementById('pinInput').value;
            if (!pin) { alert("Enter PIN!"); return; }

            isVideoCall = videoMode;
            uiSetup.style.display = 'none';
            uiInCall.style.display = 'block';
            statusDiv.innerText = videoMode ? "Starting Camera..." : "Accessing Mic...";

            try {
                // 1. FORCE VOICE MODE CONSTRAINTS
                // This is the "Nuclear Option" to try and trick Android into using the earpiece.
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1, // FORCE MONO (Key for voice mode)
                        sampleRate: 48000 // Standard voice rate
                    },
                    video: videoMode ? { facingMode: 'user' } : false
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (videoMode) {
                    localVideo.srcObject = localStream;
                    localVideo.style.display = 'block';
                }

                socket.emit('join', { pin: pin });
                statusDiv.innerText = "Waiting for partner...";

                peerConnection = new RTCPeerConnection({ iceServers: iceServers });
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // 2. AUDIO ROUTING HANDLER
                peerConnection.ontrack = event => {
                    if (event.track.kind === 'video') {
                        remoteVideo.srcObject = event.streams[0];
                        remoteVideo.style.display = 'block';
                        remoteVideo.play().catch(e => console.log("Video Play Error:", e));
                        visual.style.display = 'none';
                        statusDiv.innerText = ""; 
                    } else {
                        // AUDIO HANDLING
                        if (isVideoCall) {
                            // Video Call -> Loudspeaker is normal.
                        } else {
                            // Voice Call -> Try Reset Trick
                            remoteAudio.srcObject = event.streams[0];
                            
                            // TRICK: Pause/Play sequence to reset audio driver
                            remoteAudio.pause();
                            setTimeout(() => {
                                remoteAudio.play().catch(e => console.log("Audio Play Error:", e));
                            }, 500);

                            statusDiv.innerText = "â¤ï¸ Connected (Voice)";
                            visual.innerText = "ðŸ—£ï¸";
                            visual.classList.add("pulse");
                        }
                    }
                };

                peerConnection.onicecandidate = event => {
                    if (event.candidate) socket.emit('signal', { 'candidate': event.candidate });
                };

            } catch (err) { 
                alert("Error: " + err); 
                location.reload(); 
            }
        }

        // --- Socket Logic ---
        socket.on('auth_error', (data) => { alert(data.message); location.reload(); });
        
        socket.on('ready', async () => {
            if (!peerConnection) return;
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('signal', { 'sdp': offer });
        });

        socket.on('signal', async (data) => {
            if (!peerConnection) return;
            if (data.sdp) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                if (data.sdp.type === 'offer') {
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('signal', { 'sdp': answer });
                }
            } else if (data.candidate) {
                try { await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch (e) {}
            }
        });
    </script>
</body>
</html>
