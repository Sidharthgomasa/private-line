<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Line</title>
    <meta name="theme-color" content="#121212">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2913/2913133.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body { margin: 0; background: #121212; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        /* VIDEO CONTAINERS */
        #remoteVideo {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; display: none; background: #000;
        }
        #localVideo {
            position: absolute; bottom: 20px; right: 20px; width: 100px; height: 140px;
            background: #333; border: 2px solid #ff4d4d; border-radius: 10px;
            object-fit: cover; z-index: 2; transform: scaleX(-1); display: none;
        }

        /* UI LAYOUT */
        #ui-layer { position: relative; z-index: 10; text-align: center; width: 100%; }
        
        h1 { color: #ff4d4d; font-weight: 300; letter-spacing: 2px; }

        /* INPUTS */
        #pinInput {
            padding: 15px; font-size: 20px; border-radius: 12px;
            border: 2px solid #333; background: #222; color: white;
            text-align: center; width: 200px; margin-bottom: 25px; outline: none;
        }

        /* BUTTONS */
        .btn {
            padding: 15px 40px; font-size: 18px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold; margin: 10px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        
        #callBtn { background: linear-gradient(145deg, #ff4d4d, #cc0000); }
        
        /* HIDDEN BUTTONS (Show during call) */
        #inCallControls { display: none; }
        
        #videoBtn { background: #444; border: 1px solid #666; }
        #endBtn { background: #cc0000; }

        /* STATUS CIRCLE */
        .circle { width: 120px; height: 120px; background: #2a2a2a; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 20px auto; font-size: 40px; border: 2px solid #ff4d4d; }
        .pulse { animation: pulse 1.5s infinite; background: #ff4d4d; border: none; }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(255, 77, 77, 0); } 100% { transform: scale(0.95); } }

    </style>
</head>
<body>

    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>

    <div id="ui-layer">
        <div id="setup-ui">
            <h1>ðŸ”’ PRIVATE LINE</h1>
            <input type="tel" id="pinInput" placeholder="Enter PIN" maxlength="10">
            <br>
            <button id="callBtn" class="btn" onclick="startCall()">ðŸ“ž Voice Call</button>
        </div>

        <div id="inCallControls">
            <div id="visual" class="circle">ðŸš€</div>
            <div id="status" style="margin-bottom: 20px; color: #aaa;">Connecting...</div>
            <button id="videoBtn" class="btn" onclick="requestVideoUpgrade()">ðŸ“¹ Switch to Video</button>
            <br>
            <button id="endBtn" class="btn" onclick="location.reload()">End Call</button>
        </div>
    </div>

    <audio id="remoteAudio" autoplay playsinline></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // --- PWA INSTALLATION ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js');
        }

        // --- APP LOGIC ---
        const socket = io();
        const uiSetup = document.getElementById('setup-ui');
        const uiInCall = document.getElementById('inCallControls');
        const statusDiv = document.getElementById('status');
        const visual = document.getElementById('visual');
        const videoBtn = document.getElementById('videoBtn');
        const remoteAudio = document.getElementById('remoteAudio');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');
        
        let peerConnection;
        let localStream;
        let isVideoEnabled = false;

        const METERED_API_KEY = "d79e5424a466fa259d9deecb140f92c064dd";
        let iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];

        window.onload = async () => {
            try {
                const response = await fetch(`https://connect-v.metered.live/api/v1/turn/credentials?apiKey=${METERED_API_KEY}`);
                iceServers = await response.json();
                console.log("Premium Servers Loaded");
            } catch (e) { console.error("Backup servers used"); }
        };

        async function startCall() {
            const pin = document.getElementById('pinInput').value;
            if (!pin) { alert("Enter PIN!"); return; }

            uiSetup.style.display = 'none';
            uiInCall.style.display = 'block';
            statusDiv.innerText = "Accessing Mic...";

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                socket.emit('join', { pin: pin });
                statusDiv.innerText = "Waiting for partner...";

                peerConnection = new RTCPeerConnection({ iceServers: iceServers });
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = event => {
                    if (event.track.kind === 'video') {
                        remoteVideo.srcObject = event.streams[0];
                        remoteVideo.style.display = 'block';
                        localVideo.style.display = 'block';
                        visual.style.display = 'none';
                        statusDiv.innerText = "";
                    } else {
                        remoteAudio.srcObject = event.streams[0];
                        statusDiv.innerText = "â¤ï¸ Connected (Audio)";
                        visual.innerText = "ðŸ—£ï¸";
                        visual.classList.add("pulse");
                    }
                };

                peerConnection.onicecandidate = event => {
                    if (event.candidate) socket.emit('signal', { 'candidate': event.candidate });
                };

            } catch (err) { alert("Mic Error: " + err); location.reload(); }
        }

        function requestVideoUpgrade() {
            if (isVideoEnabled) return;
            statusDiv.innerText = "Requesting Video...";
            socket.emit('signal', { type: 'request_video' });
        }

        async function enableVideoMode() {
            try {
                const videoStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: { facingMode: 'user' } });
                localVideo.srcObject = videoStream;
                localVideo.style.display = 'block';
                const videoTrack = videoStream.getVideoTracks()[0];
                const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.replaceTrack(videoTrack);
                else peerConnection.addTrack(videoTrack, videoStream);
                
                isVideoEnabled = true;
                videoBtn.style.display = 'none';
                visual.style.display = 'none';
                statusDiv.innerText = "Video Active";
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('signal', { 'sdp': offer });
            } catch (e) { alert("Camera Error: " + e); }
        }

        socket.on('auth_error', (data) => { alert(data.message); location.reload(); });
        socket.on('ready', async () => {
            if (!peerConnection) return;
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('signal', { 'sdp': offer });
        });
        socket.on('signal', async (data) => {
            if (data.type === 'request_video') {
                const accept = confirm("Partner wants to switch to Video Call. Accept?");
                if (accept) { await enableVideoMode(); socket.emit('signal', { type: 'accept_video' }); }
                return;
            }
            if (data.type === 'accept_video') {
                statusDiv.innerText = "Request Accepted!"; await enableVideoMode(); return;
            }
            if (!peerConnection) return;
            if (data.sdp) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                if (data.sdp.type === 'offer') {
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('signal', { 'sdp': answer });
                }
            } else if (data.candidate) {
                try { await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch (e) {}
            }
        });
    </script>
</body>
</html>
